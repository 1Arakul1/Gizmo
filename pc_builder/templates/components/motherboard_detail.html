<!-- templates/components/motherboard_detail.html -->
{% extends "base.html" %}

{% block content %}
    <div class="container">
        <h1>{{ motherboard.manufacturer }} {{ motherboard.model }}</h1>
        <div class="row">
            <div class="col-md-4">
                {% if motherboard.image %}
                    <img src="{{ motherboard.image.url }}" alt="{{ motherboard.model }}" class="img-fluid" style="max-width: 100%;">
                {% else %}
                    <p>Изображение отсутствует</p>
                {% endif %}
            </div>
            <div class="col-md-8">
                <p><strong>Производитель:</strong> {{ motherboard.manufacturer }}</p>
                <p><strong>Модель:</strong> {{ motherboard.model }}</p>
                <p><strong>Сокет:</strong> {{ motherboard.socket }}</p>
                <p><strong>Чипсет:</strong> {{ motherboard.chipset }}</p>
               <p><strong>Тип памяти:</strong> {{ motherboard.ram_type }}</p>
                <p><strong>Цена:</strong> {{ motherboard.price }} руб.</p>

                <form id="add-to-cart-form" method="post" action="{% url 'builds:add_to_cart' %}"
                      data-url="{% url 'builds:add_to_cart' %}">
                    {% csrf_token %}
                    <input type="hidden" name="component_type" value="motherboard">
                    <input type="hidden" name="component_id" value="{{ motherboard.pk }}">
                    <div class="form-group">
                        <label for="quantity">Количество:</label>
                        <input type="number" class="form-control" id="quantity" name="quantity" value="1" min="1">
                    </div>
                    <button type="submit" class="btn btn-success" {% if not in_stock %}disabled{% endif %}>
                        {% if in_stock %}
                            Добавить в корзину
                        {% else %}
                            Нет в наличии
                        {% endif %}
                    </button>
                </form>
                <div id="add-to-cart-message"></div>
                <!-- Контейнер для сообщения -->
            </div>
        </div>
        <a href="{% url 'components:motherboard_list' %}" class="btn btn-secondary mt-3">Вернуться к списку материнских плат</a>
    </div>

    <!--  ОТЗЫВЫ  -->
    <div class="container mt-5">
        <h2>Отзывы</h2>

        {% if motherboard.reviews.all %}
            {% for review in motherboard.reviews.all %}
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">{{ review.user.username }} - {{ review.rating }} звезд</h5>
                        <p class="card-text">{{ review.text }}</p>
                        <p class="card-text"><small class="text-muted">{{ review.created_at }}</small></p>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p>Пока нет ни одного отзыва.</p>
        {% endif %}

        {% if user.is_authenticated %}
            <h2>Добавить отзыв</h2>
            <form method="post" action="{% url 'components:add_review' motherboard.pk 'motherboard' %}">
                {% csrf_token %}
                {{ review_form.as_p }}
                <button type="submit" class="btn btn-primary">Отправить отзыв</button>
            </form>
        {% else %}
            <p>Пожалуйста, <a href="{% url 'users:login' %}">войдите</a>, чтобы оставить отзыв.</p>
        {% endif %}
    </div>
        <!-- Индикатор загрузки -->
    <div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 20px;">
            Загрузка...
        </div>
    </div>

    <script>
        $(document).ready(function() {
            function showLoading() {
                $('#loading-overlay').show();
            }

            function hideLoading() {
                $('#loading-overlay').hide();
            }

            $('#add-to-cart-form').submit(function(event) {
                event.preventDefault();

                var form = $(this);
                var url = form.data('url');

                showLoading();

                $.ajax({
                    type: "POST",
                    url: url,
                    data: form.serialize(),
                    dataType: 'json', //  <--  Укажите dataType: 'json'
                    success: function(response) {
                        hideLoading();
                        if (response.status === 'success') {
                            // Перенаправление на страницу корзины
                            window.location.href = "{% url 'builds:cart' %}"; //  <-- Добавлено перенаправление
                        } else {
                            $('#add-to-cart-message').html('<div class="alert alert-danger">' + response.message + '</div>');
                             setTimeout(function() {
                                $('#add-to-cart-message').empty();
                            }, 3000);
                        }
                    },
                    error: function(xhr, status, error) {
                        hideLoading();
                        $('#add-to-cart-message').html('<div class="alert alert-danger">Произошла ошибка при добавлении в корзину.</div>');
                        setTimeout(function() {
                            $('#add-to-cart-message').empty();
                        }, 3000);
                    }
                });
            });
        });
    </script>
{% endblock %}